# 项目部署

---

### 实体机部署

#### 安装nginx

1. 编译安装Nginx源码：

   ```shell
   # 安装必要的第三方依赖包
   sudo apt-get -y install libpcre3 libpcre3-dev
   sudo apt-get -y install zlib1g-dev
   sudo apt-get install openssl libssl-dev
   # 下载稳定的Nginx版本
   wget http://nginx.org/download/nginx-1.16.1.tar.gz
   # 解压编译安装
   # 安装后的执行文件路径：/usr/local/nginx/sbin/
   # 配置文件路径：/usr/local/nginx/conf/
   tar -zxvf nginx-1.16.1.tar.gz
   cd nginx-1.16.1
   ./configure --prefix=/usr/local/nginx
   make
   sudo make install
   # 创建配置文件子目录 并在nginx.conf文件中包含conf.d
   # 在末尾添加 include /usr/local/nginx/conf/conf.d/*.conf;
   # 目的是在部署即时通讯的web管理后台时将对应的.conf文件拷贝到 /usr/local/nginx/conf/conf.d 目录时就能够被 nginx.conf 包含
   sudo mkdir /usr/local/nginx/conf/conf.d
   sudo mkdir -p /usr/local/nginx/conf/conf.d/
   sudo vim /usr/local/nginx/conf/nginx.conf
   # 将默认的80端口修改为81 因为web管理后台需要占用80端口
   server {
   	listen 81;
   	server_name localhost;
   	wcharset koi8-r;
   }
   ```

2. 配置启动Nginx

   ```shell
   # 创建一个nginx.service
   # 在 /lib/systemd/system/目录下面新建一个nginx.service文件，并赋予可执行的权限
   sudo vim /lib/systemd/system/nginx.service
   # 编辑service内容
   [Unit]
   Description=nginx - high performance web server
   After=network.target remote-fs.target nss-lookup.target
   [Install]
   WantedBy=multi-user.target
   [Service]
   Type=forking
   ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
   ExecReload=/usr/local/nginx/sbin/nginx -s reload
   ExecStop=/usr/local/nginx/sbin/nginx -s stop
   # 启动服务
   # 在启动服务之前，需要先重载systemctl命令
   sudo systemctl daemon-reload
   sudo systemctl start nginx.service # 启动nginx
   ```

3. 启动/停止/重启Nginx服务

   ```shell
   sudo systemctl start nginx.service	# 启动
   sudo systemctl stop nginx.service	# 停止
   sudo systemctl reload nginx.service 	# 重新加载
   systemctl status nginx.service			# 显示nginx服务的状态
   sudo systemctl enable nginx.service		# 在开机时启用nginx服务
   sudo systemctl disable nginx.service	# 在开机时禁用nginx服务
   ```

4. 查看Nginx运行情况：

   ```shell
   sudo ps -ef | grep nginx
   sudo netstat -tap | grep nginx
   sudo lsof -i:81	# 查看81端口监听情况
   ```

   ![image-20250215013158233](assets\image-20250215013158233.png)

#### 项目打包部署

在项目src\conf目录下包含：config.php，database.php，im.com.conf三个配置文件：

1. config.php：配置了msfs图片服务器的地址，修改 `$config['msfs_url']` 至对应的ip地址即可，
2. dababase.php：配置了连接mysql数据库所需参数，根据自己的需求修改`hostname`、`username`、`password` 这三个参数即可
3. im.conf：Nignx配置文件不建议改动，包含了php的配置以及php所需的nginx相关配置

如果使用的是现有的nginx + php环境：

1. 可以修改setup.sh中的 `PHP_WEB_SETUP_PATH` 为nginx放置 web代码的路径
2. 并且将 `PHP_NGINX_CONF_PATH` 修改为nginx配置文件的路径
3. 然后执行setup.sh脚本即可

```nginx
# im.com.conf
# 配置nginx如何处理http请求、php文件以及静态资源
server
{
    # 基本信息
    listen       80;																# 监听 80 端口
    server_name  0.0.0.0;															# 绑定所有 IP（0.0.0.0）
    index index.html index.htm index.php default.html default.htm default.php;		# 默认首页文件
    root         /var/www/html/im-server-web;										# 网站根目录
	
    # PHP 文件处理

    # Nginx + PHP-FPM 配合处理 PHP 请求的核心配置
    # 匹配以 .php 结尾的请求
    location ~ \.php($|/) {
        fastcgi_pass   unix:/run/php/php7.2-fpm.sock;							# 将请求转发给 PHP-FPM 解析（这里用的是 Unix Socket）
        fastcgi_index  index.php;
        fastcgi_split_path_info ^(.+\.php)(.*)$;								# 支持 /index.php/xxx 这种路径形式
        fastcgi_param   PATH_INFO $fastcgi_path_info;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;		# 指定 PHP 脚本的绝对路径
        include        fastcgi_params;											# 引入标准 FastCGI 参数
    }
	
    # 静态资源缓存
    # 对图片/Flash 文件缓存 30 天
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    {
            expires      30d;
    }
	
    # 对 JS/CSS 文件缓存 12 小时
    location ~ .*\.(js|css)?$
    {
            expires      12h;
    }
    # URL重写
    if (!-e $request_filename) {
        rewrite ^/(.*)$ /index.php/$1 last;
        break;
    }
}
```



### 容器化部署

项目场景为Nginx+php的方案（传统的LEMP架构），这与单纯的使用nginx提供静态文件或反向代理不太一样，php需要php-fpm来解析执行php脚本。

1. 方案1：nginx官方镜像 + 独立的php-fpm容器（推荐生成环境）方案思路：

   nginx与php-fpm分别运行在不同的容器中，通过fastCGI进行通信，

   - Nginx 容器负责处理 HTTP 请求
   - PHP-FPM 容器负责解析 PHP
   - Nginx 通过 `fastcgi_pass` 转发请求给 PHP-FPM 
   - 优点：Nginx 和 PHP-FPM 独立容器化管理清晰、可以单独扩展 Nginx 或 PHP-FPM 容器、容器镜像小更新方便

以下按照方案1进行teamtalk-web管理后台的容器化部署方案：

#### docker命令部署

##### 网络创建

```shell
# 创建私有网络
docker network create teamtalk-net
docker network ls
```

##### teamtalk-php容器部署

```shell
cd teamtalk-php
# 先拉取镜像
docker pull php:7.4-fpm
# 启动创建PHP-FPM容器
docker run -d --name teamtalk-php \
  --network teamtalk-net \
  -v $(pwd)/src:/var/www/html/im-server-web \
  -v $(pwd)/php/config.php:/var/www/html/im-server-web/application/config/config.php:ro \
  -v $(pwd)/php/database.php:/var/www/html/im-server-web/application/config/database.php:ro \
  -p 9000:9000 \
  php:7.4-fpm
# 进入PHP-FPM容器安装必要的扩展
docker exec -it teamtalk-php /bin/bash
apt update
apt install -y libpng-dev libjpeg-dev libfreetype6-dev libzip-dev
docker-php-ext-configure gd --with-freetype --with-jpeg
docker-php-ext-install -j$(nproc) gd pdo pdo_mysql mysqli zip
exit
# 重启PHP-FPM容器使扩展生效
docker restart teamtalk-php
docker ps | grep teamtalk-php							# 查看容器状态
docker exec teamtalk-php ps aux | grep teamtalk-php		# 检查PHP-FPM是否正常运行
```

##### teamtalk-nginx容器部署

```shell
# 拉取nginx镜像
docker pull nginx:1.25
# 启动Nginx容器，连接到同一个网络，并挂载项目文件和配置文件
docker run -d --name teamtalk-nginx \
  --network teamtalk-net \
  -p 25001:80 \
  -v $(pwd)/src:/var/www/html/im-server-web:ro \
  -v $(pwd)/nginx/im.conf:/etc/nginx/conf.d/default.conf:ro \
  -v $(pwd)/nginx/im.conf:/etc/nginx/conf.d/im.conf:ro \
  nginx:1.25
```

##### 测试部署

```shell
# 检查所有容器状态
docker ps
```

```shell
# 检查容器网络连通性
# 在 nginx 容器内测试连接 php-fpm 的 9000 端口
docker exec -it nginx /bin/bash
apt update && apt install -y telnet
telnet teamtalk-php 9000

# 或者使用 curl 测试
apt install -y curl
curl http://teamtalk-php:9000
```

```shell
# 有时候响应是HTTP302跳转或空白页面，直接curl看不出来
curl -i http://127.0.0.1:25001
curl -v http://127.0.0.1:25001
```



#### dockerfile部署

##### php/Dockerfile

```dockerfile
FROM php:7.4-fpm

# 安装依赖并清理缓存
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
      libpng-dev libjpeg-dev libfreetype6-dev libzip-dev zip unzip git \
  && docker-php-ext-configure gd --with-freetype --with-jpeg \
  && docker-php-ext-install -j$(nproc) gd pdo pdo_mysql mysqli zip mbstring \
  && rm -rf /var/lib/apt/lists/*

# 工作目录（容器内）
WORKDIR /var/www/html/im-server-web

# 复制默认配置（仅构建时有用，dev 时会被 volume 覆盖）
COPY ../src /var/www/html/im-server-web
COPY config.php /var/www/html/im-server-web/application/config/config.php
COPY database.php /var/www/html/im-server-web/application/config/database.php

# 创建日志目录并调整权限（php-fpm 用 www-data）
RUN mkdir -p /var/www/html/im-server-web/application/logs \
  && chown -R www-data:www-data /var/www/html/im-server-web

EXPOSE 9000
CMD ["php-fpm"]
```

##### nginx/Dockerfile

```dockerfile
FROM nginx:1.25
COPY im.conf /etc/nginx/conf.d/default.conf
COPY ../src /var/www/html/im-server-web
```

##### 构建镜像并运行

```shell
cd teamtalk-web
# 构建 php 镜像
docker build -t teamtalk-php:1.0 -f php/Dockerfile .
# 构建 nginx 镜像（可选）
docker build -t teamtalk-nginx:1.0 -f nginx/Dockerfile .
# 运行 php（不映射 9000 到宿主，仅在内部网络可访问）
docker run -d --name teamtalk-php \
  --network teantalk-net \
  -v $(pwd)/src:/var/www/html/im-server-web:ro \
  -v $(pwd)/php/config.php:/var/www/html/im-server-web/application/config/config.php:ro \
  -v $(pwd)/php/database.php:/var/www/html/im-server-web/application/config/database.php:ro \
  --env-file .env \
  --restart unless-stopped \
  teamtalk-php:7.4
# 运行 nginx（把 80 映射到宿主 25001）
docker run -d --name teamtalk-nginx \
  --network teantalk-net \
  -p 25001:80 \
  -v $(pwd)/src:/var/www/html/im-server-web:ro \
  -v $(pwd)/nginx/im.conf:/etc/nginx/conf.d/default.conf:ro \
  --restart unless-stopped \
  teamtalk-nginx:1.0
```

##### .env文件

```json
DB_HOST=teamtalk-mysql
DB_USER=root
DB_PASS=20001201
DB_NAME=teamtalk
APP_BASE_URL=http://localhost:25001
MSFS_URL=http://106.75.230.157:8700/
HTTP_URL=http://106.75.230.157:8400/
```



#### docker-compose容器编排

```yaml
version: '3.9'

services:
  php:
    build:
      context: .
      dockerfile: ./php/Dockerfile
    image: teamtalk/php:1.0
    container_name: teamtalk-php
    volumes:
      - ./src:/var/www/html/im-server-web
      - ./php/config.php:/var/www/html/im-server-web/application/config/config.php
      - ./php/database.php:/var/www/html/im-server-web/application/config/database.php
    environment:
      DB_HOST: ${DB_HOST}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_NAME: ${DB_NAME}
      APP_BASE_URL: ${APP_BASE_URL}
      MSFS_URL: ${MSFS_URL}
      HTTP_URL: ${HTTP_URL}
    networks:
      - teamtalk-net

  nginx: 
    build:
      context: .
      dockerfile: ./nginx/Dockerfile
    image: teamtalk/nginx:1.0
    container_name: teamtalk-nginx
    ports:
      - "25001:80"
    volumes:
      - ./src:/var/www/html/im-server-web:ro
      - ./nginx/im.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php
    networks:
      - teamtalk-net

networks:
  teamtalk-net:
    driver: bridge
```

```shell
# 生成镜像
docker compose build
# 以后台方式启动服务
docker compose up -d
# 生成镜像并运行
docker compose up -d --build
```

```shell
# 查看当前项目的容器
docker compose ps
# 查看当前项目的网络
docker compose network ls
# 查看所有网络（会显示完整的命名）
docker network ls
```



### 部署过程问题

重复302循环跳转问题，

通过curl测试无法获取到正常界面，并且无任何返回。查看nginx在监听80端口、php服务已经在监听9000端口。排查步骤如下：

1. 确定基础网络连通性：teamtalk-nginx -> teamtalk-php

   ```shell
   docker exec -it teamtalk-nginx bash
   telnet teamtalk-php 9000
   ```

2. php页面测试：test.php

   ```php
   <?php
   phpinfo();
   ```

   ```shell
   # 页面测试
   curl http://127.0.0.1:25001/test.php
   ```

```http
HTTP/1.1 302 Found
Server: nginx/1.25.5
Date: Sat, 27 Sep 2025 02:56:11 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
X-Powered-By: PHP/7.4.33
Set-Cookie: ci_session=a%3A5%3A%7Bs%3A10%3A%22session_id%22%3Bs%3A32%3A%22723c64d9d3325e0696a1d6b79f327d9b%22%3Bs%3A10%3A%22ip_address%22%3Bs%3A10%3A%22172.18.0.1%22%3Bs%3A10%3A%22user_agent%22%3Bs%3A11%3A%22curl%2F7.58.0%22%3Bs%3A13%3A%22last_activity%22%3Bi%3A1758941771%3Bs%3A9%3A%22user_data%22%3Bs%3A0%3A%22%22%3B%7Db10771850a358c3ac50f60b123701c2add2e7838; expires=Sat, 27-Sep-2025 04:56:11 GMT; Max-Age=7200; path=/
Location: http://106.75.230.157:25001/auth/login
```

问题原因如下：

1. 宿主机访问 `127.0.0.1:25001` -> 进入 **teamtalk-nginx** 容器 (nginx:1.25) -> nginx再把请求转发给 **teamtalk-php** (php-fpm)
2. PHP 程序（CodeIgniter 系）发现当前请求的Host 不等于配置的 base_url，于是返回302跳转
3. 最后 `curl -iL`就真的去请求 `http://106.75.230.157:25001/auth/login`，实际上还是打回 nginx → PHP 程序又认为 Host 不匹配 → 再跳一次。
4. 结果就是 **无限 302 循环** 

